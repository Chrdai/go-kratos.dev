<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.0">
<link rel="alternate" type="application/rss+xml" href="/en/blog/rss.xml" title="Kratos Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/en/blog/atom.xml" title="Kratos Blog Atom Feed">
<script src="https://cdn.staticfile.org/pangu/4.0.7/pangu.min.js"></script>
<script src="/js/custom.js"></script><title data-react-helmet="true">Posts tagged &quot;opentelemetry&quot; | Kratos</title><meta data-react-helmet="true" property="og:title" content="Posts tagged &quot;opentelemetry&quot; | Kratos"><meta data-react-helmet="true" name="description" content="Blog | Tagged &quot;opentelemetry&quot;"><meta data-react-helmet="true" property="og:description" content="Blog | Tagged &quot;opentelemetry&quot;"><meta data-react-helmet="true" property="og:url" content="https://go-kratos.dev/en/blog/tags/open-telemetry"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-react-helmet="true" name="keywords" content="Go,Kratos,OpenTracing,OpenCencus,OpenTelemetry,Google,Dapper,operation process"><link data-react-helmet="true" rel="shortcut icon" href="/en/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://go-kratos.dev/en/blog/tags/open-telemetry"><link data-react-helmet="true" rel="alternate" href="https://go-kratos.dev/blog/tags/open-telemetry" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://go-kratos.dev/en/blog/tags/open-telemetry" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://go-kratos.dev/blog/tags/open-telemetry" hreflang="x-default"><link rel="stylesheet" href="/en/assets/css/styles.20ec9982.css">
<link rel="preload" href="/en/assets/js/runtime~main.baee257e.js" as="script">
<link rel="preload" href="/en/assets/js/main.c550a788.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/en/"><img src="/en/img/logo.svg" alt="Kratos Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/en/img/logo.svg" alt="Kratos Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Kratos</strong></a><a class="navbar__item navbar__link" href="/en/docs/">Docs</a><a href="https://pkg.go.dev/github.com/go-kratos/kratos/v2/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">API</a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/en/blog">Blog</a><a href="https://github.com/go-kratos/kratos" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" style="vertical-align:text-bottom;margin-right:5px"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>English</span></span></a><ul class="dropdown__menu"><li><a href="/blog/tags/open-telemetry" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">中文</a></li><li><a href="/en/blog/tags/open-telemetry" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">English</a></li></ul></div><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="navbar__search searchBarContainer_MM2z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_s5VG searchBarLoadingRing_2jQk"><div></div><div></div><div></div><div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/en/"><img src="/en/img/logo.svg" alt="Kratos Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/en/img/logo.svg" alt="Kratos Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Kratos</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/en/docs/">Docs</a></li><li class="menu__list-item"><a href="https://pkg.go.dev/github.com/go-kratos/kratos/v2/" target="_blank" rel="noopener noreferrer" class="menu__link">API</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/en/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/go-kratos/kratos" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li><li class="menu__list-item menu__list-item--collapsed"><a href="#" role="button" class="menu__link menu__link--sublist"><span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" style="vertical-align:text-bottom;margin-right:5px"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>Languages</span></span></a><ul class="menu__list"><li class="menu__list-item"><a href="/blog/tags/open-telemetry" target="_self" rel="noopener noreferrer" class="menu__link" style="text-transform:capitalize">中文</a></li><li class="menu__list-item"><a href="/en/blog/tags/open-telemetry" target="_self" rel="noopener noreferrer" class="menu__link dropdown__link--active" style="text-transform:capitalize">English</a></li></ul></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-page"><div class="container margin-vert--lg"><div class="row"><div class="col col--3"><div class="sidebar_2ahu thin-scrollbar"><h3 class="sidebarItemTitle_2hhb">Recent posts</h3><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/en/blog/go-kratos-opentelemetry-practice">Kratos 学习笔记 - 基于 OpenTelemetry 的链路追踪</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/en/blog/go-layout-operation-process">Kratos 学习笔记 - 通过 layout 简单分析应用是如何跑起来的</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/en/blog/go-project-layout">Go工程化 - Project Layout 最佳实践</a></li></ul></div></div><main class="col col--7"><h1>One post tagged with &quot;opentelemetry&quot;</h1><a href="/en/blog/tags">View All Tags</a><div class="margin-vert--xl"><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_GeHD"><a href="/en/blog/go-kratos-opentelemetry-practice">Kratos 学习笔记 - 基于 OpenTelemetry 的链路追踪</a></h2><div class="margin-vert--md"><time datetime="2021-06-03T00:00:00.000Z" class="blogPostDate_fNvV">June 3, 2021 · 5 min read</time></div><div class="avatar margin-vert--md"><a href="https://github.com/shenqidebaozi" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars.githubusercontent.com/u/35397691?s=60&amp;v=4" alt="shenqidebaozi"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/shenqidebaozi" target="_blank" rel="noopener noreferrer">shenqidebaozi</a></h4><small class="avatar__subtitle">Maintainer of go-kratos</small></div></div></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="链路追踪的前世今生"></a>链路追踪的前世今生<a class="hash-link" href="#链路追踪的前世今生" title="Direct link to heading">#</a></h2><blockquote><p>分布式跟踪（也称为分布式请求跟踪）是一种用于分析和监控应用程序的方法，尤其是使用微服务架构构建的应用程序。分布式跟踪有助于精确定位故障发生的位置以及导致性能差的原因。   </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="起源"></a>起源<a class="hash-link" href="#起源" title="Direct link to heading">#</a></h3><p>链路追踪(Distributed Tracing)　一词最早出现于谷歌发布的论文 <strong>《Dapper, a Large-Scale Distributed Systems Tracing Infrastructure》</strong> 中,这篇论文对于实现链路追踪,对于后来出现的 Jaeger、Zipkin 等开源分布式追踪项目设计理念仍有很深的影响。</p></blockquote><p>微服务架构是一个分布式的架构,会有很多个不同的服务。不同的服务之前相互调用,如果出现了错误由于一个请求经过了 N 个服务。随着业务的增加越来越多的服务之间的调用，如果没有一个工具去记录调用链，解决问题的时候就会像下面图片里小猫咪玩的毛线球一样，毫无头绪，无从下手
<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e2dd5606765649969819396ba574a741~tplv-k3u1fbpfcp-watermark.image" alt="image.png">
所以需要有一个工具能够清楚的了解一个请求经过了哪些服务,顺序是如何,从而能够轻易的定位问题。
<img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7098634cefe74a3cbacf5e76c343bd81~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="百家争艳"></a>百家争艳<a class="hash-link" href="#百家争艳" title="Direct link to heading">#</a></h3><p>从谷歌发布 <strong>Dapper</strong> 后，分布式链路追踪工具越来越多，以下简单列举了一些常用的链路追踪系统</p><ul><li>Skywalking</li><li>阿里 鹰眼</li><li>大众点评 CAT</li><li>Twitter Zipkin</li><li>Naver pinpoint</li><li>Uber Jaeger</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="争锋相对？"></a>争锋相对？<a class="hash-link" href="#争锋相对？" title="Direct link to heading">#</a></h3><p>随着链路追踪工具越来越多，开源领域主要分为两派，一派是以 <strong>CNCF技术委员</strong> 会为主的  <strong>OpenTracing</strong> 的规范，例如 jaeger zipkin 都是遵循了<strong>OpenTracing</strong> 的规范。而另一派则是谷歌作为发起者的 <strong>OpenCensus</strong>，而且谷歌本身还是最早提出链路追踪概念的公司，后期连微软也加入了 <strong>OpenCensus</strong>
<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3029f1315fe34ec884858d33d41cb1ce~tplv-k3u1fbpfcp-watermark.image" alt="截屏2021-05-29 下午9.56.57.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="opentelemetry-诞生"></a>OpenTelemetry 诞生<a class="hash-link" href="#opentelemetry-诞生" title="Direct link to heading">#</a></h3><blockquote><p>OpenTelemetric 是一组 API、SDK、模组和集成，专为创建和管理‎‎遥测数据‎‎（如追踪、指标和日志）而设</p></blockquote><p>微软加入 <strong>OpenCensus</strong> 后，直接打破了之前平衡的局面，间接的导致了 <strong>OpenTelemetry</strong> 的诞生
谷歌和微软下定决心结束江湖之乱，首要的问题是如何整合两个两个社区已有的项目，OpenTelemetry 主要的理念就是，兼容 <strong>OpenCensus</strong> 和 <strong>OpenTracing</strong> ，可以让使用者无需改动或者很小的改动就可以接入 <strong>OpenTelemetry</strong></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="kratos-的链路追踪实践"></a>Kratos 的链路追踪实践<a class="hash-link" href="#kratos-的链路追踪实践" title="Direct link to heading">#</a></h2><blockquote><p>Kratos 一套轻量级 Go 微服务框架，包含大量微服务相关框架及工具。</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="tracing-中间件"></a>tracing 中间件<a class="hash-link" href="#tracing-中间件" title="Direct link to heading">#</a></h3><p>kratos 框架提供的自带中间件中有一个名为 <strong>tracing</strong> 中间件，它基于 <strong>Opentelemetry</strong> 实现了kratos 框架的链路追踪功能，中间件的代码可以从 <strong><a href="https://github.com/go-kratos/kratos/tree/main/middleware/tracing" target="_blank" rel="noopener noreferrer">middleware/tracing</a></strong> 中看到。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="实现原理"></a>实现原理<a class="hash-link" href="#实现原理" title="Direct link to heading">#</a></h4><p>kratos 的链路追踪中间件由三个文件组成 <strong>carrie.go</strong>,<strong>tracer.go</strong>,<strong>tracing.go</strong>。client和 server 的实现原理基本相同，本文以 server 实现进行原理解析。</p><ol><li>首先当请求进入时，<strong>tracing</strong> 中间件会被调用,首先调用了 <strong>tracer.go</strong> 中的 <strong>NewTracer</strong> 方法</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly golang"><div tabindex="0" class="prism-code language-golang codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// Server returns a new server middleware for OpenTelemetry.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">func Server(opts ...Option) middleware.Middleware {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // 调用 tracer.go 中的 NewTracer 传入了一个 SpanKindServer 和配置项</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    tracer := NewTracer(trace.SpanKindServer, opts...)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // ... 省略代码</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ol start="2"><li><strong>tracer.go</strong> 中的 <strong>NewTracer</strong> 方法被调用后会返回一个 <strong>Tracer</strong>,实现如下</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">func </span><span class="token function maybe-class-name" style="color:rgb(130, 170, 255)">NewTracer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">kind trace</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access maybe-class-name">SpanKind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> opts </span><span class="token spread operator" style="color:rgb(137, 221, 255)">...</span><span class="token maybe-class-name">Option</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token maybe-class-name">Tracer</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    options </span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> options</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword control-flow" style="font-style:italic">for</span><span class="token plain"> _</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> o </span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> range opts </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token function" style="color:rgb(130, 170, 255)">o</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain">options</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// 判断是否存在 otel 追踪提供者配置，如果存在则设置</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword control-flow" style="font-style:italic">if</span><span class="token plain"> options</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access maybe-class-name">TracerProvider</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">!=</span><span class="token plain"> nil </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        otel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access maybe-class-name" style="color:rgb(130, 170, 255)">SetTracerProvider</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">options</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access maybe-class-name">TracerProvider</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*</span></div><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">        判断是否存在 Propagators 设置，如果存在设置则覆盖，不存在则设置一个默认的TextMapPropagator</span></div><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">        注意如果没有设置默认的TextMapPropagator,链路信息则无法正确的传递</span></div><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">        */</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword control-flow" style="font-style:italic">if</span><span class="token plain"> options</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access maybe-class-name">Propagators</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">!=</span><span class="token plain"> nil </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        otel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access maybe-class-name" style="color:rgb(130, 170, 255)">SetTextMapPropagator</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">options</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access maybe-class-name">Propagators</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">    otel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access maybe-class-name" style="color:rgb(130, 170, 255)">SetTextMapPropagator</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">propagation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access maybe-class-name" style="color:rgb(130, 170, 255)">NewCompositeTextMapPropagator</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">propagation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access maybe-class-name">Baggage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> propagation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access maybe-class-name">TraceContext</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> name string</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// 判断当前中间件的类型，是 server 还是 client</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword control-flow" style="font-style:italic">if</span><span class="token plain"> kind </span><span class="token operator" style="color:rgb(137, 221, 255)">==</span><span class="token plain"> trace</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access maybe-class-name">SpanKindServer</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        name </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;server&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="font-style:italic">else</span><span class="token plain"> </span><span class="token keyword control-flow" style="font-style:italic">if</span><span class="token plain"> kind </span><span class="token operator" style="color:rgb(137, 221, 255)">==</span><span class="token plain"> trace</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access maybe-class-name">SpanKindClient</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        name </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;client&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token function" style="color:rgb(130, 170, 255)">panic</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">fmt</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access maybe-class-name" style="color:rgb(130, 170, 255)">Sprintf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;unsupported span kind: %v&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// 调用 otel包的 Tracer 方法 传入 name 用来创建一个 tracer 实例</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    tracer </span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> otel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access maybe-class-name" style="color:rgb(130, 170, 255)">Tracer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword control-flow" style="font-style:italic">return</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token maybe-class-name">Tracer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">tracer</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> tracer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> kind</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ol start="3"><li>判断当前请求类型，处理需要采集的数据，并调用 <strong>tracer.go</strong> 中的 <strong>Start</strong> 方法</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly golang"><div tabindex="0" class="prism-code language-golang codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                component string</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                operation string</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                carrier   propagation.TextMapCarrier</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // 判断请求类型</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if info, ok := http.FromServerContext(ctx); ok {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                // HTTP</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                component = &quot;HTTP&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                // 取出请求的地址</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                operation = info.Request.RequestURI</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                // 调用 otel/propagation包中的 HeaderCarrier，会处理 http.Header 以用来满足TextMapCarrier interface</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                // TextMapCarrier 是一个文本映射载体，用于承载信息</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                carrier = propagation.HeaderCarrier(info.Request.Header)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                // otel.GetTextMapPropagator().Extract() 方法用于将文本映射载体，读取到上下文中</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                ctx = otel.GetTextMapPropagator().Extract(ctx, propagation.HeaderCarrier(info.Request.Header))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            } else if info, ok := grpc.FromServerContext(ctx); ok {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                // Grpc</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                component = &quot;gRPC&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                operation = info.FullMethod</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                //</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                // 调用 grpc/metadata包中metadata.FromIncomingContext(ctx)传入 ctx，转换 grpc 的元数据</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                if md, ok := metadata.FromIncomingContext(ctx); ok {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    // 调用carrier.go 中的 MetadataCarrier 将 MD 转换 成文本映射载体</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    carrier = MetadataCarrier(md)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        // 调用 tracer.Start 方法</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            ctx, span := tracer.Start(ctx, component, operation, carrier)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        // ... 省略代码</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ol start="4"><li>调用 <strong>tracing.go</strong> 中的 <strong>Start</strong> 方法</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly golang"><div tabindex="0" class="prism-code language-golang codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">func (t *Tracer) Start(ctx context.Context, component string, operation string, carrier propagation.TextMapCarrier) (context.Context, trace.Span) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // 判断当前中间件如果是 server则将 carrier 注入到上下文中</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if t.kind == trace.SpanKindServer {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ctx = otel.GetTextMapPropagator().Extract(ctx, carrier)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // 调用otel/tracer 包中的 start 方法，用来创建一个 span</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ctx, span := t.tracer.Start(ctx,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // tracing.go 中声明的请求路由作为 spanName</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        operation,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // 设置 span 的属性，设置了一个 component，component的值为请求类型</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        trace.WithAttributes(attribute.String(&quot;component&quot;, component)),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // 设置 span种类</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        trace.WithSpanKind(t.kind),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // 判断如果当前中间件是 client 则将 carrier 注入到请求里面</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if t.kind == trace.SpanKindClient {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        otel.GetTextMapPropagator().Inject(ctx, carrier)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return ctx, span</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ol start="5"><li><strong>defer</strong> 声明了一个闭包方法</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly golang"><div tabindex="0" class="prism-code language-golang codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// 这个地方要注意，需要使用闭包，因为 defer 的参数是实时计算的如果异常发生，err 会一直为 nil</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// https://github.com/go-kratos/kratos/issues/927</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">defer func() { tracer.End(ctx, span, err) }()</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ol start="6"><li>中间件继续执行</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly golang"><div tabindex="0" class="prism-code language-golang codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// tracing.go 69行</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">reply, err = handler(ctx, req)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ol start="7"><li>中间件调用结束 <strong>defer</strong> 中的闭包被调用后执行了 <strong>tracer.go</strong> 中的 <strong>End</strong> 方法</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly golang"><div tabindex="0" class="prism-code language-golang codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">func (t *Tracer) End(ctx context.Context, span trace.Span, err error) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // 判断是否有异常发生，如果有则设置一些异常信息</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if err != nil {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // 记录异常</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        span.RecordError(err)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // 设置span 属性</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        span.SetAttributes(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // 设置事件为异常</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            attribute.String(&quot;event&quot;, &quot;error&quot;),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // 设置 message 为 err.Error().</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            attribute.String(&quot;message&quot;, err.Error()),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        //设置了 span 的状态</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        span.SetStatus(codes.Error, err.Error())</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    } else {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // 如果没有发生异常，span 状态则为 ok</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        span.SetStatus(codes.Ok, &quot;OK&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // 中止 span</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    span.End()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="如何使用"></a>如何使用<a class="hash-link" href="#如何使用" title="Direct link to heading">#</a></h4><p>tracing 中间件的使用示例可以从  <a href="https://github.com/go-kratos/kratos/tree/main/examples/traces" target="_blank" rel="noopener noreferrer">kratos/examples/traces</a> ,该示例简单的实现了跨服务间的链路追踪,以下代码片段包含部分示例代码。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly golang"><div tabindex="0" class="prism-code language-golang codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// https://github.com/go-kratos/kratos/blob/7f835db398c9d0332e69b81bad4c652b4b45ae2e/examples/traces/app/message/main.go#L38</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// 首先调用otel 库方法，得到一个 TracerProvider</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">func tracerProvider(url string) (*tracesdk.TracerProvider, error) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // examples/traces 中使用的是 jaeger，其他方式可以查看 opentelemetry 官方示例</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    exp, err := jaeger.NewRawExporter(jaeger.WithCollectorEndpoint(jaeger.WithEndpoint(url)))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if err != nil {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return nil, err</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    tp := tracesdk.NewTracerProvider(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        tracesdk.WithSampler(tracesdk.AlwaysSample()),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // 设置 Batcher，注册jaeger导出程序</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        tracesdk.WithBatcher(exp),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // 记录一些默认信息</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        tracesdk.WithResource(resource.NewWithAttributes(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            semconv.ServiceNameKey.String(pb.User_ServiceDesc.ServiceName),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            attribute.String(&quot;environment&quot;, &quot;development&quot;),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            attribute.Int64(&quot;ID&quot;, 1),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        )),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return tp, nil</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="在-grpcserver-中使用"></a>在 grpc/server 中使用<a class="hash-link" href="#在-grpcserver-中使用" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly golang"><div tabindex="0" class="prism-code language-golang codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// https://github.com/go-kratos/kratos/blob/main/examples/traces/app/message/main.go</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    grpcSrv := grpc.NewServer(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        grpc.Address(&quot;:9000&quot;),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        grpc.Middleware(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            middleware.Chain(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                recovery.Recovery(),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                // Configuring tracing Middleware</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                tracing.Server(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    tracing.WithTracerProvider(tp),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    ),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                ),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                logging.Server(logger),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            ),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ))</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="在-grpcclient-中使用"></a>在 grpc/client 中使用<a class="hash-link" href="#在-grpcclient-中使用" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly golang"><div tabindex="0" class="prism-code language-golang codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// https://github.com/go-kratos/kratos/blob/149fc0195eb62ee1fbc2728adb92e1bcd1a12c4e/examples/traces/app/user/main.go#L63</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    conn, err := grpc.DialInsecure(ctx,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        grpc.WithEndpoint(&quot;127.0.0.1:9000&quot;),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        grpc.WithMiddleware(middleware.Chain(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            tracing.Client(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                tracing.WithTracerProvider(s.tracer),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                tracing.WithPropagators(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    propagation.NewCompositeTextMapPropagator(propagation.Baggage{}, propagation.TraceContext{}),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                ),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            ),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            recovery.Recovery())),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        grpc.WithTimeout(2*time.Second),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    )</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="在-httpserver-中使用"></a>在 http/server 中使用<a class="hash-link" href="#在-httpserver-中使用" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly golang"><div tabindex="0" class="prism-code language-golang codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// https://github.com/go-kratos/kratos/blob/main/examples/traces/app/user/main.go</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    httpSrv := http.NewServer(http.Address(&quot;:8000&quot;))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    httpSrv.HandlePrefix(&quot;/&quot;, pb.NewUserHandler(s,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        http.Middleware(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            middleware.Chain(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                recovery.Recovery(),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                // Configuring tracing middleware</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                tracing.Server(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    tracing.WithTracerProvider(tp),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    tracing.WithPropagators(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        propagation.NewCompositeTextMapPropagator(propagation.Baggage{}, propagation.TraceContext{}),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    ),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                ),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                logging.Server(logger),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            ),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        )),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    )</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="在-httpclient-中使用"></a>在 http/client 中使用<a class="hash-link" href="#在-httpclient-中使用" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly golang"><div tabindex="0" class="prism-code language-golang codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">    http.NewClient(ctx, http.WithMiddleware(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        tracing.Client(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            tracing.WithTracerProvider(s.tracer),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ))</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="如何实现一个其他场景的-tracing"></a>如何实现一个其他场景的 tracing<a class="hash-link" href="#如何实现一个其他场景的-tracing" title="Direct link to heading">#</a></h4><p>我们可以借鉴 <strong>kratos</strong> 的 <strong>tracing</strong> 中间件的代码来实现例如数据库的 <strong>tracing</strong>，如下面的代码片段，作者借鉴了<strong>tracing</strong> 中间件，实现了 <strong>qmgo</strong> 库操作 <strong>MongoDB</strong> 数据库的 <strong>tracing</strong>。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly golang"><div tabindex="0" class="prism-code language-golang codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">func mongoTracer(ctx context.Context,tp trace.TracerProvider, command interface{}) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    otel.SetTracerProvider(tp)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        commandName string</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        failure     string</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        nanos       int64</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        reply       bson.Raw</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        queryId     int64</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        eventName   string</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    reply = bson.Raw{}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    switch value := command.(type) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    case *event.CommandStartedEvent:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        commandName = value.CommandName</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        reply = value.Command</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        queryId = value.RequestID</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        eventName = &quot;CommandStartedEvent&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    case *event.CommandSucceededEvent:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        commandName = value.CommandName</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        nanos = value.DurationNanos</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        queryId = value.RequestID</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        eventName = &quot;CommandSucceededEvent&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    case *event.CommandFailedEvent:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        commandName = value.CommandName</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        failure = value.Failure</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        nanos = value.DurationNanos</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        queryId = value.RequestID</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        eventName = &quot;CommandFailedEvent&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    duration, _ := time.ParseDuration(strconv.FormatInt(nanos, 10) + &quot;ns&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    tracer := otel.Tracer(&quot;mongodb&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    kind := trace.SpanKindServer</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ctx, span := tracer.Start(ctx,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        commandName,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        trace.WithAttributes(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            attribute.String(&quot;event&quot;, eventName),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            attribute.String(&quot;command&quot;, commandName),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            attribute.String(&quot;query&quot;, reply.String()),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            attribute.Int64(&quot;queryId&quot;, queryId),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            attribute.String(&quot;ms&quot;, duration.String()),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        trace.WithSpanKind(kind),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if failure != &quot;&quot; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        span.RecordError(errors.New(failure))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    span.End()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="参考文献"></a>参考文献<a class="hash-link" href="#参考文献" title="Direct link to heading">#</a></h2><ul><li><a href="https://www.researchgate.net/publication/239595848_Dapper_a_Large-Scale_Distributed_Systems_Tracing_Infrastructure" target="_blank" rel="noopener noreferrer">谷歌论文《Dapper, a Large-Scale Distributed Systems Tracing Infrastructure》</a></li><li><a href="https://opentelemetry.io/" target="_blank" rel="noopener noreferrer">OpenTelemetry 官网</a></li><li><a href="https://static.sched.com/hosted_files/kccncosschn19chi/03/OpenTelemetry_%20Overview%20%26%20Backwards%20Compatibility%20of%20OpenTracing%20%2B%20OpenCensus%20-%20Steve%20Flanders%2C%20Omnition.pdf" target="_blank" rel="noopener noreferrer">KubeCon2019 OpenTelemetry分享</a></li><li><a href="https://go-kratos.dev/docs/getting-started/start" target="_blank" rel="noopener noreferrer">Kratos 框架</a></li><li><a href="https://github.com/go-kratos/kratos/tree/main/examples/traces" target="_blank" rel="noopener noreferrer">traces 示例</a></li></ul></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/en/blog/tags/go">go</a><a class="margin-horiz--sm" href="/en/blog/tags/golang">golang</a><a class="margin-horiz--sm" href="/en/blog/tags/链路追踪">链路追踪</a><a class="margin-horiz--sm" href="/en/blog/tags/open-telemetry">OpenTelemetry</a><a class="margin-horiz--sm" href="/en/blog/tags/源码分析">源码分析</a></div><div class="col text--right"><a aria-label="Read more about Kratos 学习笔记 - 基于 OpenTelemetry 的链路追踪" href="/en/blog/go-kratos-opentelemetry-practice"><strong>Read More</strong></a></div></footer></article></div></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/en/docs/">Guides</a></li><li class="footer__item"><a href="http://v1.go-kratos.dev/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Kratos v1(legacy)</a></li><li class="footer__item"><a href="https://github.com/go-kratos/go-kratos.dev" target="_blank" rel="noopener noreferrer" class="footer__link-item">Docs Repo</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://discord.gg/BWzJsUJ" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/en/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/go-kratos/kratos" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 go-kratos.dev</div></div></div></footer></div>
<script src="/en/assets/js/runtime~main.baee257e.js"></script>
<script src="/en/assets/js/main.c550a788.js"></script>
</body>
</html>